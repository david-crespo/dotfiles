"$schema" = "https://jj-vcs.github.io/jj/latest/config-schema.json"

[user]
name = "David Crespo"
email = "crespo.dm@gmail.com"

[[--scope]]
--when.repositories = ["~/oxide"]
[--scope.user]
email = "david.crespo@oxidecomputer.com"

[remotes.origin]
auto-track-created-bookmarks = "*"

[remotes.mine]
auto-track-created-bookmarks = "*"

# Delta uses less by default but doesn't pass -X to it, which would the last
# page stick around after quit. I could use
#
#   pager = ["delta", "--pager", "less -FRX"]
#
# but I don't want this behavior on diffs, only the commit log, where I'm
# trying to look at a change ID. So instead what I've done is map Q to toggle
# --redraw-on-quit on before quitting. See ./lesskey.
# https://github.com/gwsw/less/issues/36#issuecomment-913200056

[ui]
# side by side diff if screen is wide enough
pager = [
  "zsh",
  "-c",
  '[ "${COLUMNS}" -ge 160 ] && delta --side-by-side || delta',
]
default-command = ["log", "--template", "home"]
diff-editor = ":builtin"
merge-editor = "vscode"
diff-formatter = ":git"

[revsets]
# default is 2 ancestors and I found it wasn't enough
log = "present(@) | ancestors(immutable_heads().., 4) | present(trunk()) | divergent()"

[revset-aliases]
# Treat commits not authored by me as immutable. The `trunk().. &` bit is an
# optimization to scan for non-`mine()` commits only among commits that are not
# in `trunk()`.
# https://jj-vcs.github.io/jj/v0.26.0/config/#set-of-immutable-commits
"immutable_heads()" = "builtin_immutable_heads() | (trunk().. & ~mine())"
"fork(x)" = "fork_point(trunk() | x)"
"fork()" = "fork_point(trunk() | @)"

[aliases]
d = ["diff"]
dm = ["describe", "-m"]
dp = ["describe", "-r", "@-"]
# diff rev against fork point like GitHub PR diff or git ...
# dt/dts exclude lock files and openapi schemas; dta/dtas show all files
dt = ["util", "exec", "--", "zsh", "-c", '''
  jj diff --from "fork_point(trunk() | ${1:-@})" --to "${1:-@}" \
    '~glob:"**/package-lock.json"' '~glob:"**/Cargo.lock"' '~glob:"**/openapi/**"'
  ''', 'jj dt']
dts = ["util", "exec", "--", "zsh", "-c", '''
  jj diff --stat --from "fork_point(trunk() | ${1:-@})" --to "${1:-@}" \
    '~glob:"**/package-lock.json"' '~glob:"**/Cargo.lock"' '~glob:"**/openapi/**"'
  ''', 'jj dts']
dta = ["util", "exec", "--", "zsh", "-c", '''
  jj diff --from "fork_point(trunk() | ${1:-@})" --to "${1:-@}"
  ''', 'jj dta']
dtas = ["util", "exec", "--", "zsh", "-c", '''
  jj diff --stat --from "fork_point(trunk() | ${1:-@})" --to "${1:-@}"
  ''', 'jj dtas']
rp = ["log", "--no-graph", "-T", "commit_id"]
ds = ["diff", "--stat"]
cm = ["commit"]
# move the closest ancestor bookmark to @-. prefers non-trunk bookmarks so
# that merging trunk doesn't drag the trunk bookmark forward. falls back to
# including trunk if it's the only ancestor bookmark. the jj log prints "x"
# per matching rev; grep -q tests whether there's any output (i.e., the
# revset matched something). if not, we widen the revset to include trunk.
tug = ["util", "exec", "--", "zsh", "-c", '''
  from='heads(::@ & bookmarks()) ~ trunk()'
  jj --no-pager log -r "$from" --no-graph -T '"x"' 2>/dev/null | grep -q . || from='heads(::@ & bookmarks())'
  jj bookmark move --from "$from" --to '@-'
  ''', 'jj tug']
# jj collapse START [END]
# squash START::END into START
# second arg optional. if left out does all descendants of START
collapse = ["util", "exec", "--", "zsh", "-c", '''
  jj squash -f "$1"::"$2" -t "$1"
  ''', 'jj collapse']
watch = ["util", "exec", "--", "zsh", "-c", '''
  watchexec --quiet --clear --restart --watch=.jj/repo/op_heads/heads --ignore-nothing --wrap-process=none -- jj --ignore-working-copy
  ''', 'jj watch']
spr = ["util", "exec", "--", "jj-spr"]
# merge trunk into rev. doesn't move any bookmarks
mm = ["util", "exec", "--", "zsh", "-c", '''
  jj new "$1" 'trunk()' -m 'merge trunk' && jj new
  ''', 'jj mm']

[template-aliases]
# log with diff stats for working copy or revs without descriptions. The  |
# separator has to be swapped out because jjui uses | as a separator when
# parsing lines
'home' = '''
builtin_log_compact ++ if(
  (self.current_working_copy() || self.description().len() == 0) && !self.empty(),
  "\n" ++ stringify(self.diff().stat()).replace("|", "ï½œ") ++ "\n"
)
'''

# Username part of the email address
'format_short_signature(signature)' = 'signature.email().local()'

# format_commit_summary_with_refs minus the git commit, and remove empty label
# color from description_placeholder
# https://github.com/jj-vcs/jj/blob/faa689a7/cli/src/config/templates.toml#L192C1
'zsh_prompt_summary(commit, refs)' = '''
separate(" ",
  format_short_change_id_with_change_offset(commit),
  if(commit.conflict(), label("conflict", "(conflict)")),
  if(commit.empty(),
    label("empty", "(empty)"),
  ),
  if(commit.description(),
    commit.description().first_line(),
    label("description placeholder", "(no desc)")
  ),
)
'''
